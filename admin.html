$(document).ready(function() {
    let currentPhotoIndex = 0;

    $('#viewButton').on('click', function() {
        var ward = $('#wardSelect').val();
        var date = $('#datePicker').val();
        var viewAllWards = $('#viewAllWardsCheckbox').is(':checked');
        var isLaundry = $('#laundryCheckbox').is(':checked');

        if ($('#viewAllCheckbox').is(':checked')) {
            loadPhotos(null, null, viewAllWards, isLaundry); // 전체 보기
        } else if (viewAllWards || (ward && date)) {
            loadPhotos(ward, date, viewAllWards, isLaundry);
        } else {
            alert('병동과 날짜를 선택하세요.');
        }
    });

    $('#wardSelect').on('change', function() {
        var ward = $(this).val();
        var date = $('#datePicker').val();
        if (ward && date) {
            loadPhotos(ward, date, $('#viewAllWardsCheckbox').is(':checked'), $('#laundryCheckbox').is(':checked'));
        }
    });

    $('#datePicker').on('change', function() {
        var ward = $('#wardSelect').val();
        var date = $(this).val();
        if (ward && date) {
            loadPhotos(ward, date, $('#viewAllWardsCheckbox').is(':checked'), $('#laundryCheckbox').is(':checked'));
        }
    });

    function loadPhotos(selectedWard, date, viewAllWards, isLaundry) {
        let wards = viewAllWards ? getAllWards() : [selectedWard];
        let photos = [];

        wards.forEach(ward => {
            let wardPhotosRef = isLaundry ? database.ref('laundryPhotos/' + ward) : database.ref('photos/' + ward);
            wardPhotosRef.once('value', (snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    let photo = childSnapshot.val();
                    photo.ward = ward;
                    photos.push(photo);
                });

                // 데이터를 모두 가져온 후에 화면에 표시
                if (ward === wards[wards.length - 1]) {
                    displayPhotos(photos, date);
                }
            });
        });
    }

    function displayPhotos(photos, date) {
        $('#photoGallery').empty();

        let filteredPhotos = photos;
        if (date) {
            filteredPhotos = photos.filter(photo => photo.date.split(' ')[0] === date);
        }

        filteredPhotos.forEach(photo => {
            let photoContainer = $('<div>').addClass('photo-container');
            let formattedDate = formatDateToKorean(photo.date);
            let dateLabel = $('<div>').addClass('date-label').text(formattedDate);
            let wardLabel = $('<div>').addClass('ward-label').text(getWardLabel(photo.ward));
            let img = $('<img>').attr('src', photo.url);
            let deleteButton = $('<button>').addClass('delete-button').text('삭제하기');

            deleteButton.on('click', function() {
                if (confirm('정말 삭제하시겠습니까?')) {
                    deletePhoto(photo.ward, photo);
                }
            });

            img.on('click', function() {
                openModal(photo.url);
            });

            photoContainer.append(dateLabel, img, wardLabel, deleteButton);
            $('#photoGallery').append(photoContainer);
        });

        currentPhotoIndex = 0;
        showPhoto(currentPhotoIndex);
        toggleNavigationButtons(filteredPhotos.length);
    }

    function showPhoto(index) {
        let photos = $('.photo-container');
        photos.hide();
        if (photos.length > 0) {
            $(photos[index]).show();
        }
    }

    function toggleNavigationButtons(photoCount) {
        if (photoCount <= 1) {
            $('#prevButton, #nextButton').hide();
        } else {
            $('#prevButton, #nextButton').show();
        }
    }

    function uploadPhoto(file, isLaundry) {
        let ward = $('#wardSelect').val();
        let date = new Date(new Date().getTime() + (9 * 60 * 60 * 1000)).toISOString().slice(0, 16).replace("T", " ");

        let formData = new FormData();
        formData.append('image', file);
        formData.append('key', API_KEY);

        // 업로드 버튼을 비활성화하고 업로드 중 메시지로 변경
        $('#cameraButton').prop('disabled', true).text('업로드 중...');

        $.ajax({
            url: 'https://api.imgbb.com/1/upload',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function(response) {
                let photoUrl = response.data.url;
                let refPath = isLaundry ? 'laundryPhotos/' + ward : 'photos/' + ward;
                let newPhotoRef = database.ref(refPath).push();
                newPhotoRef.set({
                    url: photoUrl,
                    date: date
                }).then(() => {
                    // 사진 업로드가 완료되면 업로드 버튼을 다시 활성화하고 텍스트를 "카메라"로 변경
                    $('#cameraButton').prop('disabled', false).text('카메라');
                    
                    // 사진 로드 함수 호출
                    loadPhotos(ward, date.split(' ')[0], $('#viewAllWardsCheckbox').is(':checked'), isLaundry);
                });
            },
            error: function() {
                // 업로드 실패 시 처리
                alert('사진 업로드 중 오류가 발생했습니다.');
                
                // 업로드 버튼을 다시 활성화하고 텍스트를 "카메라"로 변경
                $('#cameraButton').prop('disabled', false).text('카메라');
            }
        });
    }

    function deletePhoto(ward, photo) {
        let refPath = $('#laundryCheckbox').is(':checked') ? 'laundryPhotos/' + ward : 'photos/' + ward;
        let photoRef = database.ref(refPath).orderByChild('url').equalTo(photo.url);
        photoRef.once('value', function(snapshot) {
            snapshot.forEach(function(childSnapshot) {
                childSnapshot.ref.remove().then(() => {
                    alert('사진이 삭제되었습니다.');
                    loadPhotos(ward, photo.date.split(' ')[0], $('#viewAllWardsCheckbox').is(':checked'), $('#laundryCheckbox').is(':checked'));
                }).catch((error) => {
                    console.error('삭제 중 오류가 발생했습니다:', error);
                    alert('삭제 중 오류가 발생했습니다.');
                });
            });
        });
    }

    function openModal(imageUrl) {
        var modal = document.getElementById("myModal");
        var modalImg = document.getElementById("modalImage");

        modal.style.display = "block";
        modalImg.src = imageUrl;

        var span = document.getElementsByClassName("close")[0];
        span.onclick = function() {
            modal.style.display = "none";
        }
    }

    function formatDateToKorean(dateString) {
        var date = new Date(dateString);
        var year = ('' + date.getFullYear()); // .slice(-2); // 년도를 두 자리 숫자로 표시
        var month = ('0' + (date.getMonth() + 1)).slice(-2);
        var day = ('0' + date.getDate()).slice(-2);
        var hours = date.getHours();
        var minutes = ('0' + date.getMinutes()).slice(-2);
        var period = hours >= 12 ? '오후' : '오전'; // 오후/오전 구분

        // 12시간제로 변경 및 오전/오후 표시
        if (hours === 0) {
            hours = 12; // 자정을 12시로 표시
        } else if (hours > 12) {
            hours -= 12; // 오후 시간을 12시간제로 변환
        }

        return `${year}-${month}-${day} ${period}${hours}시${minutes}분`;
    }

    function getWardLabel(wardCode) {
        var wardLabels = {
            'ward93': '93 병동',
            'ward83': '83 병동',
            'ward73': '73 병동',
            'ward71': '71 병동',
            'ward63': '63 병동',
            'ward62': '62 병동',
            'ward61': '61 병동',
            'HR': 'HR 병동',
            'ward52': '52 병동',
            'ward51': '51 병동',
            'ward42': '42 병동',
            'ward41': '41 병동',
            'ICU': '중환자실',
            'dayWard': '낮병동',
            'endoscopy': '내시경실',
            'ER': '응급실'
        };
        return wardLabels[wardCode] || wardCode;
    }

    function getAllWards() {
        return ['ward93', 'ward83', 'ward73', 'ward71', 'ward63', 'ward62', 'ward61', 'HR', 'ward52', 'ward51', 'ward42', 'ward41', 'ICU', 'dayWard', 'endoscopy', 'ER'];
    }

    // 이전 및 다음 버튼 클릭 이벤트 핸들러
    $('#prevButton').on('click', function() {
        currentPhotoIndex = (currentPhotoIndex - 1 + $('.photo-container').length) % $('.photo-container').length;
        showPhoto(currentPhotoIndex);
    });

    $('#nextButton').on('click', function() {
        currentPhotoIndex = (currentPhotoIndex + 1) % $('.photo-container').length;
        showPhoto(currentPhotoIndex);
    });

    // 초기화
    $('#prevButton, #nextButton').hide();
});

// Modal 창을 닫기 위한 외부 클릭 이벤트
window.onclick = function(event) {
    var modal = document.getElementById("myModal");
    if (event.target == modal) {
        modal.style.display = "none";
    }
}